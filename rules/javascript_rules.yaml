rules:

  # =========================================================
  # A01: Broken Access Control
  # =========================================================
  - id: js-missing-auth-check
    severity: HIGH
    languages: [javascript]
    pattern: |
      app.$METHOD($PATH, (...args) => {
        ...
      })
    message: "Route handler without visible authentication or authorization checks."
    metadata:
      cwe: CWE-284
      owasp: A01:2021-Broken Access Control


  # =========================================================
  # A02: Cryptographic Failures
  # =========================================================
  - id: js-weak-hash-md5
    severity: MEDIUM
    languages: [javascript]
    pattern: crypto.createHash("md5")
    message: "MD5 is cryptographically weak."
    metadata:
      cwe: CWE-327
      owasp: A02:2021-Cryptographic Failures

  - id: js-hardcoded-secret
    severity: HIGH
    languages: [javascript]
    pattern-regex: "(password|secret|token|apiKey)\\s*[:=]\\s*['\"][^'\"]+['\"]"
    message: "Hardcoded secret detected."
    metadata:
      cwe: CWE-798
      owasp: A02:2021-Cryptographic Failures


  # =========================================================
  # A03: Injection
  # =========================================================
  - id: js-eval-usage
    severity: CRITICAL
    languages: [javascript]
    pattern: eval(...)
    message: "Use of eval() can lead to code injection."
    metadata:
      cwe: CWE-95
      owasp: A03:2021-Injection

  - id: js-function-constructor
    severity: CRITICAL
    languages: [javascript]
    pattern: new Function(...)
    message: "Dynamic function construction detected."
    metadata:
      cwe: CWE-95
      owasp: A03:2021-Injection

  - id: js-command-injection
    severity: HIGH
    languages: [javascript]
    pattern-either:
      - pattern: child_process.exec(...)
      - pattern: child_process.execSync(...)
    message: "Command execution may lead to command injection."
    metadata:
      cwe: CWE-78
      owasp: A03:2021-Injection

  - id: js-nosql-injection
    severity: HIGH
    languages: [javascript]
    mode: taint
    source:
      - req.query
      - req.body
      - req.params
    sink:
      - db.collection(...).find(...)
      - db.collection(...).update(...)
    message: "User input flows into NoSQL query without sanitization."
    metadata:
      cwe: CWE-943
      owasp: A03:2021-Injection


  # =========================================================
  # A04: Insecure Design
  # =========================================================
  - id: js-insecure-random
    severity: MEDIUM
    languages: [javascript]
    pattern: Math.random()
    message: "Math.random() is not suitable for security-sensitive operations."
    metadata:
      cwe: CWE-338
      owasp: A04:2021-Insecure Design


  # =========================================================
  # A05: Security Misconfiguration
  # =========================================================
  - id: js-debug-enabled
    severity: MEDIUM
    languages: [javascript]
    pattern: app.set("env", "development")
    message: "Application running in development mode."
    metadata:
      cwe: CWE-489
      owasp: A05:2021-Security Misconfiguration

  - id: js-cors-any-origin
    severity: MEDIUM
    languages: [javascript]
    pattern: res.setHeader("Access-Control-Allow-Origin", "*")
    message: "CORS allows all origins."
    metadata:
      cwe: CWE-942
      owasp: A05:2021-Security Misconfiguration


  # =========================================================
  # A06: Vulnerable and Outdated Components
  # =========================================================
  - id: js-unsafe-require
    severity: MEDIUM
    languages: [javascript]
    pattern: require($VAR)
    message: "Dynamic require detected. This can lead to dependency confusion."
    metadata:
      cwe: CWE-829
      owasp: A06:2021-Vulnerable Components


  # =========================================================
  # A07: Identification & Authentication Failures
  # =========================================================
  - id: js-plaintext-password-compare
    severity: HIGH
    languages: [javascript]
    pattern: "if ($PWD === $INPUT)"
    message: "Plaintext password comparison detected."
    metadata:
      cwe: CWE-521
      owasp: A07:2021-Identification and Authentication Failures

  - id: js-jwt-no-verify
    severity: HIGH
    languages: [javascript]
    pattern: jwt.decode(...)
    message: "JWT decoded without signature verification."
    metadata:
      cwe: CWE-347
      owasp: A07:2021-Identification and Authentication Failures


  # =========================================================
  # A08: Software and Data Integrity Failures
  # =========================================================
  - id: js-unsafe-deserialization
    severity: CRITICAL
    languages: [javascript]
    pattern: JSON.parse(...)
    message: "Unsafe deserialization of untrusted data without validation."
    metadata:
      cwe: CWE-502
      owasp: A08:2021-Software and Data Integrity Failures


  # =========================================================
  # A09: Logging and Monitoring Failures
  # =========================================================
  - id: js-empty-catch
    severity: LOW
    languages: [javascript]
    pattern: |
      try {
        ...
      } catch (e) {
      }
    message: "Empty catch block detected."
    metadata:
      cwe: CWE-391
      owasp: A09:2021-Logging and Monitoring Failures


  # =========================================================
  # A10: Server-Side Request Forgery (SSRF)
  # =========================================================
  - id: js-ssrf
    severity: HIGH
    languages: [javascript]
    mode: taint
    source:
      - req.query
      - req.body
    sink:
      - axios.get(...)
      - fetch(...)
      - request(...)
    message: "User input used in outbound HTTP request (possible SSRF)."
    metadata:
      cwe: CWE-918
      owasp: A10:2021-SSRF


  # =========================================================
  # Additional High-Impact Vulnerabilities
  # =========================================================
  - id: js-path-traversal
    severity: HIGH
    languages: [javascript]
    mode: taint
    source:
      - req.query
      - req.params
    sink:
      - fs.readFile(...)
      - fs.readFileSync(...)
    message: "User input used in file path (possible path traversal)."
    metadata:
      cwe: CWE-22

  - id: js-xss-reflected
    severity: HIGH
    languages: [javascript]
    mode: taint
    source:
      - req.query
      - req.body
    sink:
      - res.send(...)
      - res.write(...)
    message: "Reflected XSS vulnerability detected."
    metadata:
      cwe: CWE-79
