rules:
  # ============================================================================
  # SQL INJECTION - Ruby
  # ============================================================================
  
  - id: ruby-sqli-activerecord
    name: "ActiveRecord SQL Injection"
    description: "SQL injection in Rails ActiveRecord"
    severity: CRITICAL
    languages: [ruby]
    mode: taint
    pattern-sources:
      - pattern: params[...]
      - pattern: request.query_string
      - pattern: request.params[...]
    pattern-sinks:
      - pattern: ActiveRecord::Base.connection.execute(...)
      - pattern: Model.find_by_sql(...)
      - pattern: Model.where(...)
    pattern-sanitizers:
      - pattern: sanitize_sql(...)
      - pattern: to_i
    message: "SQL injection: use parameterized queries or sanitize_sql()"
    metadata:
      cwe: CWE-89
      owasp: A03:2021-Injection
      confidence: 0.95

  # ============================================================================
  # COMMAND INJECTION - Ruby
  # ============================================================================

  - id: ruby-command-injection
    name: "Ruby Command Injection"
    description: "Command injection via shell execution"
    severity: CRITICAL
    languages: [ruby]
    mode: taint
    pattern-sources:
      - pattern: params[...]
      - pattern: request.params[...]
    pattern-sinks:
      - pattern: system(...)
      - pattern: exec(...)
      - pattern: "`..`"
      - pattern: "%x{...}"
    pattern-sanitizers:
      - pattern: Shellwords.escape(...)
    message: "Command injection: use Shellwords.escape() or avoid shell execution"
    metadata:
      cwe: CWE-78
      owasp: A03:2021-Injection
      confidence: 0.98

  # ============================================================================
  # CODE INJECTION - Ruby
  # ============================================================================

  - id: ruby-code-injection-eval
    name: "Ruby Code Injection via eval"
    description: "Arbitrary code execution via eval"
    severity: CRITICAL
    languages: [ruby]
    mode: taint
    pattern-sources:
      - pattern: params[...]
      - pattern: request.params[...]
    pattern-sinks:
      - pattern: eval(...)
      - pattern: instance_eval(...)
      - pattern: class_eval(...)
    message: "Code injection: never use eval with user input"
    metadata:
      cwe: CWE-94
      owasp: A03:2021-Injection
      confidence: 1.0

  # ============================================================================
  # XSS - Ruby
  # ============================================================================

  - id: ruby-xss-rails
    name: "XSS in Rails"
    description: "Cross-Site Scripting in Rails views"
    severity: HIGH
    languages: [ruby]
    mode: taint
    pattern-sources:
      - pattern: params[...]
      - pattern: request.params[...]
    pattern-sinks:
      - pattern: raw(...)
      - pattern: html_safe
    pattern-sanitizers:
      - pattern: sanitize(...)
      - pattern: h(...)
    message: "XSS: use sanitize() or h() before rendering user input"
    metadata:
      cwe: CWE-79
      owasp: A03:2021-Injection
      confidence: 0.85

  # ============================================================================
  # SSRF - Ruby
  # ============================================================================

  - id: ruby-ssrf
    name: "SSRF in Ruby"
    description: "Server-Side Request Forgery"
    severity: HIGH
    languages: [ruby]
    mode: taint
    pattern-sources:
      - pattern: params[...]
      - pattern: request.params[...]
    pattern-sinks:
      - pattern: Net::HTTP.get(...)
      - pattern: open(...)
      - pattern: URI.open(...)
    pattern-sanitizers:
      - pattern: URI.parse(...)
    message: "SSRF: validate and whitelist URLs"
    metadata:
      cwe: CWE-918
      owasp: A10:2021-Server-Side Request Forgery
      confidence: 0.9

  # ============================================================================
  # PATH TRAVERSAL - Ruby
  # ============================================================================

  - id: ruby-path-traversal
    name: "Ruby Path Traversal"
    description: "Path traversal in file operations"
    severity: HIGH
    languages: [ruby]
    mode: taint
    pattern-sources:
      - pattern: params[...]
      - pattern: request.params[...]
    pattern-sinks:
      - pattern: File.read(...)
      - pattern: File.open(...)
      - pattern: IO.read(...)
    pattern-sanitizers:
      - pattern: File.basename(...)
      - pattern: File.expand_path(...)
    message: "Path traversal: use File.basename() to sanitize paths"
    metadata:
      cwe: CWE-22
      owasp: A01:2021-Broken Access Control
      confidence: 0.9

  # ============================================================================
  # DESERIALIZATION - Ruby
  # ============================================================================

  - id: ruby-unsafe-marshal
    name: "Unsafe Ruby Deserialization"
    description: "Code execution via Marshal.load"
    severity: CRITICAL
    languages: [ruby]
    mode: taint
    pattern-sources:
      - pattern: params[...]
      - pattern: request.body.read
    pattern-sinks:
      - pattern: Marshal.load(...)
      - pattern: YAML.load(...)
    pattern-sanitizers:
      - pattern: YAML.safe_load(...)
    message: "Unsafe deserialization: use YAML.safe_load() instead"
    metadata:
      cwe: CWE-502
      owasp: A08:2021-Software and Data Integrity Failures
      confidence: 1.0
