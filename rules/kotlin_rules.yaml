rules:

  # =========================================================
  # A01: Broken Access Control
  # =========================================================
  - id: kt-missing-auth-annotation
    severity: HIGH
    languages: [kotlin]
    pattern: |
      @RequestMapping(...)
      fun $FUNC(...) {
        ...
      }
    message: "Controller method without authentication or authorization checks."
    metadata:
      cwe: CWE-284
      owasp: A01:2021-Broken Access Control


  # =========================================================
  # A02: Cryptographic Failures
  # =========================================================
  - id: kt-weak-hash-md5
    severity: MEDIUM
    languages: [kotlin]
    pattern: MessageDigest.getInstance("MD5")
    message: "MD5 is cryptographically weak."
    metadata:
      cwe: CWE-327
      owasp: A02:2021-Cryptographic Failures

  - id: kt-weak-hash-sha1
    severity: MEDIUM
    languages: [kotlin]
    pattern: MessageDigest.getInstance("SHA-1")
    message: "SHA-1 is cryptographically weak."
    metadata:
      cwe: CWE-327
      owasp: A02:2021-Cryptographic Failures

  - id: kt-hardcoded-secret
    severity: HIGH
    languages: [kotlin]
    pattern-regex: "(password|secret|token|apiKey)\\s*=\\s*\"[^\"]+\""
    message: "Hardcoded secret detected."
    metadata:
      cwe: CWE-798
      owasp: A02:2021-Cryptographic Failures


  # =========================================================
  # A03: Injection
  # =========================================================
  - id: kt-sql-injection
    severity: CRITICAL
    languages: [kotlin]
    mode: taint
    source:
      - request.getParameter(...)
      - call.parameters.get(...)
    sink:
      - Statement.execute(...)
      - Statement.executeQuery(...)
    message: "User input reaches SQL query execution."
    metadata:
      cwe: CWE-89
      owasp: A03:2021-Injection

  - id: kt-jpa-dynamic-query
    severity: HIGH
    languages: [kotlin]
    pattern: entityManager.createQuery("...")
    message: "Dynamic JPQL query detected. Ensure parameter binding."
    metadata:
      cwe: CWE-89
      owasp: A03:2021-Injection

  - id: kt-command-injection
    severity: HIGH
    languages: [kotlin]
    pattern-either:
      - pattern: Runtime.getRuntime().exec(...)
      - pattern: ProcessBuilder(...)
    message: "Command execution detected. Possible command injection."
    metadata:
      cwe: CWE-78
      owasp: A03:2021-Injection

  - id: kt-eval-like-exec
    severity: HIGH
    languages: [kotlin]
    pattern: javax.script.ScriptEngineManager().getEngineByName(...)
    message: "Dynamic script execution detected."
    metadata:
      cwe: CWE-95
      owasp: A03:2021-Injection


  # =========================================================
  # A04: Insecure Design
  # =========================================================
  - id: kt-insecure-random
    severity: MEDIUM
    languages: [kotlin]
    pattern: Random()
    message: "java.util.Random is not cryptographically secure."
    metadata:
      cwe: CWE-338
      owasp: A04:2021-Insecure Design


  # =========================================================
  # A05: Security Misconfiguration
  # =========================================================
  - id: kt-debug-enabled
    severity: MEDIUM
    languages: [kotlin]
    pattern: server.error.include-stacktrace=always
    message: "Stack trace exposure enabled."
    metadata:
      cwe: CWE-209
      owasp: A05:2021-Security Misconfiguration

  - id: kt-open-cors
    severity: MEDIUM
    languages: [kotlin]
    pattern: allowedOrigins = "*"
    message: "CORS configured to allow all origins."
    metadata:
      cwe: CWE-942
      owasp: A05:2021-Security Misconfiguration


  # =========================================================
  # A06: Vulnerable and Outdated Components
  # =========================================================
  - id: kt-hardcoded-dependency-version
    severity: MEDIUM
    languages: [kotlin]
    pattern-regex: "implementation\\(\"[a-zA-Z0-9\\.-]+:[a-zA-Z0-9\\.-]+:[0-9\\.]+\"\\)"
    message: "Hardcoded dependency version detected. Verify for known vulnerabilities."
    metadata:
      cwe: CWE-1104
      owasp: A06:2021-Vulnerable Components


  # =========================================================
  # A07: Identification & Authentication Failures
  # =========================================================
  - id: kt-plaintext-password-compare
    severity: HIGH
    languages: [kotlin]
    pattern: if ($PWD == $INPUT)
    message: "Plaintext password comparison detected."
    metadata:
      cwe: CWE-521
      owasp: A07:2021-Identification and Authentication Failures

  - id: kt-jwt-no-verify
    severity: HIGH
    languages: [kotlin]
    pattern: Jwts.parser().parse(...)
    message: "JWT parsed without explicit signature verification."
    metadata:
      cwe: CWE-347
      owasp: A07:2021-Identification and Authentication Failures


  # =========================================================
  # A08: Software and Data Integrity Failures
  # =========================================================
  - id: kt-unsafe-deserialization
    severity: CRITICAL
    languages: [kotlin]
    pattern: ObjectInputStream(...)
    message: "Unsafe Java/Kotlin deserialization detected."
    metadata:
      cwe: CWE-502
      owasp: A08:2021-Software and Data Integrity Failures


  # =========================================================
  # A09: Logging and Monitoring Failures
  # =========================================================
  - id: kt-empty-catch
    severity: LOW
    languages: [kotlin]
    pattern: |
      try {
        ...
      } catch (e: Exception) {
      }
    message: "Empty catch block hides exceptions."
    metadata:
      cwe: CWE-391
      owasp: A09:2021-Logging and Monitoring Failures


  # =========================================================
  # A10: Server-Side Request Forgery (SSRF)
  # =========================================================
  - id: kt-ssrf
    severity: HIGH
    languages: [kotlin]
    mode: taint
    source:
      - request.getParameter(...)
      - call.parameters.get(...)
    sink:
      - URL(...)
      - HttpURLConnection.openConnection(...)
    message: "User input used in outbound network request."
    metadata:
      cwe: CWE-918
      owasp: A10:2021-SSRF


  # =========================================================
  # Android-Specific Vulnerabilities
  # =========================================================
  - id: kt-android-exported-activity
    severity: HIGH
    languages: [kotlin]
    pattern: android:exported="true"
    message: "Exported Android component may allow unauthorized access."
    metadata:
      cwe: CWE-926

  - id: kt-android-insecure-storage
    severity: HIGH
    languages: [kotlin]
    pattern: getSharedPreferences(...)
    message: "Sensitive data stored in SharedPreferences without encryption."
    metadata:
      cwe: CWE-922

  - id: kt-android-webview-js-enabled
    severity: HIGH
    languages: [kotlin]
    pattern: settings.javaScriptEnabled = true
    message: "JavaScript enabled in WebView may lead to XSS or RCE."
    metadata:
      cwe: CWE-749


  # =========================================================
  # File System & Path Traversal
  # =========================================================
  - id: kt-path-traversal
    severity: HIGH
    languages: [kotlin]
    mode: taint
    source:
      - request.getParameter(...)
    sink:
      - File(...)
      - Paths.get(...)
    message: "User input used in file path (path traversal)."
    metadata:
      cwe: CWE-22


  # =========================================================
  # Cross-Site Scripting (Backend HTML Responses)
  # =========================================================
  - id: kt-xss
    severity: HIGH
    languages: [kotlin]
    mode: taint
    source:
      - request.getParameter(...)
    sink:
      - response.writer.print(...)
      - call.respondText(...)
    message: "Reflected XSS vulnerability detected."
    metadata:
      cwe: CWE-79
